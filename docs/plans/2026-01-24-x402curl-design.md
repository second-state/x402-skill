# x402curl Design

## Overview

A Rust CLI tool that wraps HTTP requests with automatic x402 payment handling. Uses `x402-reqwest` under the hood and presents a curl-compatible interface.

## Architecture

```
User runs: x402curl -X POST -d '{"doc": "..."}' https://api.example.com/ocr
                              │
                              ▼
                    ┌─────────────────┐
                    │  Parse CLI args │
                    │  (clap crate)   │
                    └────────┬────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  Load private   │
                    │  key from config│
                    └────────┬────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  Build request  │
                    │  via x402-reqwest│
                    └────────┬────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  x402-reqwest   │
                    │  handles 402    │◄── automatic payment
                    │  transparently  │
                    └────────┬────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  Output response│
                    │  to stdout/-o   │
                    └─────────────────┘
```

## Dependencies

- `clap` — CLI argument parsing
- `x402-reqwest` — Payment-aware HTTP client (from https://github.com/x402-rs/x402-rs)
- `tokio` — Async runtime
- `dotenvy` — .env file loading
- `reqwest` — HTTP client (via x402-reqwest)

## CLI Interface

### Command Structure

```bash
x402curl [OPTIONS] <URL>
```

### Supported Flags

| Flag | Long form | Description |
|------|-----------|-------------|
| `-X` | `--request` | HTTP method (GET, POST, PUT, DELETE, etc.) |
| `-H` | `--header` | Add header (repeatable: `-H "A: 1" -H "B: 2"`) |
| `-d` | `--data` | Request body (string or `@filename`) |
| `-o` | `--output` | Write response to file instead of stdout |
| `-f` | `--fail` | Exit non-zero on HTTP 4xx/5xx |
| `-s` | `--silent` | Suppress progress/status output |
| `-v` | `--verbose` | Show payment details and request info |
| `-F` | `--form` | Multipart form field (repeatable) |
| `-u` | `--user` | Basic auth (`user:password`) |
| `-L` | `--location` | Follow redirects |
| | `--data-binary` | Send data without processing |
| | `--confirm` | Prompt before making payment |

### x402-Specific Flags

| Flag | Description |
|------|-------------|
| `--x402-key` | Override private key (not recommended) |
| `--x402-dry-run` | Show payment requirements without paying |

### Usage Examples

```bash
# Simple POST
x402curl -X POST -d '{"url": "..."}' https://api.ocr.com/scan

# File upload with verbose payment info
x402curl -v -F "file=@document.pdf" https://api.ocr.com/scan

# Require confirmation before paying
x402curl --confirm -d @input.json https://api.expensive.com/process
```

## Configuration

### Lookup Hierarchy

Configuration is resolved in this order (first match wins):

1. `--x402-key` CLI flag (if provided)
2. `X402_PRIVATE_KEY` environment variable
3. `./.env` file in current directory
4. `~/.x402/config` global config file

### Config File Format

`~/.x402/config`:

```toml
# Default private key
private_key = "0x..."

# Optional: default behavior overrides
[defaults]
verbose = false
confirm = false
```

### Key Validation

On startup, x402curl will:
1. Attempt to load the key using the hierarchy above
2. Validate it's a valid private key format (hex, correct length)
3. If no key found or invalid, exit with clear error message

### Security Considerations

- Private key is only loaded into memory when needed
- `--x402-key` flag value is hidden in verbose output (shows `--x402-key ***`)
- Config file permissions: warn if `~/.x402/config` is world-readable

## Output Behavior

### Default (Silent)

```bash
$ x402curl -X POST -d '{"text": "hello"}' https://api.translate.com/v1
{"translation": "hola", "lang": "es"}
```

No payment info shown — just the API response.

### Verbose Mode (`-v`)

```bash
$ x402curl -v -X POST -d '{"text": "hello"}' https://api.translate.com/v1
> POST https://api.translate.com/v1
> Content-Type: application/json
< 402 Payment Required
< x402-scheme: eip155
< x402-amount: 5000 USDC (base)
* Signing payment with 0x1234...abcd
* Payment submitted via facilitator
< 200 OK
{"translation": "hola", "lang": "es"}
```

### Confirmation Mode (`--confirm`)

```bash
$ x402curl --confirm -d @large.pdf https://api.ocr.com/scan
Payment required: 0.50 USDC on Base
Recipient: 0x9876...fedc
Proceed? [y/N] y
{"pages": [...]}
```

### Dry-Run Mode (`--x402-dry-run`)

```bash
$ x402curl --x402-dry-run https://api.ocr.com/scan
Payment required:
  Amount: 0.01 USDC
  Chain: Base (eip155:8453)
  Recipient: 0x9876...fedc
  Scheme: v2-eip155-exact
(dry run - no payment made)
```

## Error Handling

### Exit Codes

| Code | Meaning |
|------|---------|
| `0` | Success |
| `1` | General error (invalid args, config issues) |
| `2` | Network error (connection failed, timeout) |
| `3` | Payment error (insufficient funds, signing failed) |
| `4` | HTTP error (4xx/5xx, only with `-f` flag) |
| `5` | Configuration error (no key found, invalid key) |

### Error Messages

```bash
# No private key configured
$ x402curl https://api.example.com
Error [5]: No private key found. Set X402_PRIVATE_KEY or create ~/.x402/config

# Insufficient funds
$ x402curl https://api.example.com
Error [3]: Insufficient funds. Required: 0.50 USDC, Available: 0.12 USDC

# Network failure
$ x402curl https://api.example.com
Error [2]: Connection failed: api.example.com - timeout after 30s

# HTTP error (with -f flag)
$ x402curl -f https://api.example.com/notfound
Error [4]: HTTP 404 Not Found

# Unsupported payment scheme
$ x402curl https://api.example.com
Error [3]: Unsupported payment scheme: solana-spl. Supported: eip155
```

### Behavior Notes

- Errors always go to stderr, never stdout
- Response body still goes to stdout even on HTTP errors (unless `-f`)
- Verbose mode (`-v`) adds stack trace for debugging

## Project Structure

```
x402curl/
├── Cargo.toml
├── src/
│   ├── main.rs           # Entry point, CLI setup
│   ├── cli.rs            # Clap argument definitions
│   ├── config.rs         # Key loading, config hierarchy
│   ├── request.rs        # Build reqwest request from CLI args
│   ├── output.rs         # Response formatting, verbosity handling
│   └── error.rs          # Error types, exit codes
├── tests/
│   ├── cli_parsing.rs    # Unit tests for arg parsing
│   └── integration.rs    # End-to-end tests with mock server
└── README.md
```

## Cargo.toml

```toml
[package]
name = "x402curl"
version = "0.1.0"
edition = "2021"
description = "curl with automatic x402 payment handling"
license = "MIT"

[dependencies]
clap = { version = "4", features = ["derive"] }
tokio = { version = "1", features = ["rt-multi-thread", "macros"] }
x402-reqwest = { git = "https://github.com/x402-rs/x402-rs" }
reqwest = { version = "0.12", features = ["multipart", "json"] }
dotenvy = "0.15"
toml = "0.8"
dirs = "5"
thiserror = "2"

[dev-dependencies]
wiremock = "0.6"
assert_cmd = "2"
```

## Build Targets

- `cargo install x402curl` from crates.io
- Pre-built binaries: Linux (x86_64, aarch64), macOS (x86_64, aarch64), Windows (x86_64)
- GitHub releases with checksums
